#!/usr/bin/env zsh

aicomplete() {
  # The destination folder for the completions
  folder="$DOTFILES/zsh/completions"
  # The CLI command to autocomplete.
  cli="$1"
  # Extract the current date as a string in the format YYYY.MM.DD
  current_date=$(date +'%Y.%m.%d')
  # Output file path
  out="$folder/_$cli"

  if [ -z "$cli" ]; then
    echo "No CLI specified."
    return
  fi

  # Get the help output of the CLI command.
  help="$($cli --help)"

  # If the help output is empty, return.
  if [ -z "$help" ]; then
    echo "No help output found for $cli."
    return
  fi

  echo "Creating autocomplete for $cli...\n"

  # @TODO: aichat
  completion=$(sgpt autocomplete "$help" | tee /dev/tty | sed '2s/^/# Auto-generated by \`aicomplete\` @ '$current_date'\n/')

  confirm() {
    message="${1:-Is that okay?}"

    read -rq "?$message (y/n) "
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
      return 0
    else
      return 1
    fi
  }

  save() {
    echo ""
    echo "$completion" >"$out"
    echo "Saved \`_$cli\` to $out."

    return
  }

  abort() {
    echo "Aborted."

    return
  }

  if confirm; then
    if [ -f "$out" ]; then
      if confirm "Completion script already exists. Overwrite?"; then
        save
      else
        abort
      fi
    else
      save
    fi
  else
    abort
  fi
}

aicomplete "$1"
